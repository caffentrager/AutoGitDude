name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  windows-powershell:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PowerShell
      uses: actions/setup-powershell@v2

    - name: Install Pester
      shell: pwsh
      run: |
        Install-Module -Name Pester -Force -Scope CurrentUser -SkipPublisherCheck

    - name: Run Pester tests
      shell: pwsh
      run: |
        if (Test-Path tests) {
          Invoke-Pester -Script @{ Path = 'tests' } -EnableExit
        } else {
          Write-Host 'No tests directory found; skipping Pester.'
        }

    - name: PowerShell script syntax check
      shell: pwsh
      run: |
        $psFiles = Get-ChildItem -Path . -Recurse -Filter *.ps1 -Exclude .\.git\** | Select-Object -ExpandProperty FullName
        foreach ($f in $psFiles) {
          Write-Host "Checking: $f"
          try {
            [System.Management.Automation.Language.Parser]::ParseFile($f, [ref]$null, [ref]$null) | Out-Null
          }
          catch {
            Write-Error "Syntax error in $f : $_"
            exit 1
          }
        }
